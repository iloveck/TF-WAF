name: $(BuildDefinitionName).$(Build.SourceBranchName)$(Rev:.r)

variables:
  global_variable: value

# During initial development, the "dev" environment will be updated daily at noon
# This is to balance keeping it updated with constant deployment instability.
# Later this will become a Daily QA build with dev being continuously updated.
#warning: UTC time
schedules:
- cron: "4 19 * * *"
  displayName: Daily Dev build
  branches:
    include:
    - develop
  always: false

trigger:
- master
- develop
- feature/*
- release/*

stages:
  - stage: Build
    jobs:
    - job: Build_app
      steps:
      - task: Npm@1
        condition: and(succeeded(), or(eq(variables['Build.SourceBranch'], 'refs/heads/feature/TASK-5519_testing_cond_logic'), eq(variables['Build.SourceBranch'], 'refs/heads/feature/TASK-5519_initial_cicd')))
        displayName: 'npm install'
        inputs:
          command: 'install'
      - script: 'sudo npm install -g @angular/cli@latest'
        displayName: angularCli install
      - task: Npm@1
        displayName: 'npm build2'
        inputs:
          command: 'custom'
          customCommand: 'run build'
      - task: Npm@1
        displayName: 'npm test'
        continueOnError: true
        inputs:
          command: 'custom'
          customCommand: 'run test'
      - task: PublishTestResults@2
        displayName: 'publish test results'
        inputs:
          testResultsFormat: 'JUnit' # Options: JUnit, NUnit, VSTest, xUnit, cTest
          testResultsFiles: '$(System.DefaultWorkingDirectory)/tests/mglo-web/*.xml'
          searchFolder: '$(System.DefaultWorkingDirectory)' # Optional
          failTaskOnFailedTests: false # Optional
      - task: PublishCodeCoverageResults@1
        displayName: 'publish code coverage'
        inputs:
          codeCoverageTool: 'Cobertura'
          summaryFileLocation: '$(System.DefaultWorkingDirectory)/coverage/mglo-web/*.xml'
          reportDirectory: '$(System.DefaultWorkingDirectory)/coverage/mglo-web'
          failIfCoverageEmpty: false
      - task: ArchiveFiles@2
        displayName: 'zip deployment files'
        condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/feature/TASK-5519_initial_cicd'))
        inputs:
          rootFolderOrFile: "$(System.DefaultWorkingDirectory)/dist/mglo-web"
          includeRootFolder: false
          archiveFile: "$(System.DefaultWorkingDirectory)/build$(Build.BuildId).zip"
      - task: PublishPipelineArtifact@1
        displayName: 'publish deployment archive'
        condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/feature/TASK-5519_initial_cicd'))
        inputs:
          targetPath: '$(System.DefaultWorkingDirectory)/build$(Build.BuildId).zip'
          artifact: 'dist'
          publishLocation: 'pipeline'
  - stage: Deploy
    jobs:
    - deployment: Deploy_to_Dev
      condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/feature/TASK-5519_initial_cicd'))
      environment: development
      timeoutInMinutes: 10
      strategy:
        runOnce:
          deploy:
            steps:
            - task: DownloadPipelineArtifact@2
              displayName: 'download deployment archive'
              inputs:
                artifactName: 'dist'
                downloadPath: '$(System.DefaultWorkingDirectory)'
            - task: AzureRmWebAppDeployment@4
              inputs:
                ConnectionType: 'AzureRM'
                azureSubscription: 'WEBAKSPRD05142019'
                appType: 'webApp'
                WebAppName: 'webservertestpoc'
                packageForLinux: '$(System.DefaultWorkingDirectory)/**/*.zip'
